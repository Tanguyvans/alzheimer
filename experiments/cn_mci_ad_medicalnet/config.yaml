# Configuration for CN vs MCI vs AD with MedicalNet Transfer Learning
#
# Based on MedicalNet: https://github.com/Tencent/MedicalNet
# Pretrained 3D ResNet models on 23 medical imaging datasets
#
# Key advantages:
# - Transfer learning reduces overfitting on small datasets
# - Pretrained on medical imaging (better than ImageNet for medical tasks)
# - Proven to improve accuracy 10-20% vs training from scratch
#
# Usage:
#   Step 1: Download pretrained weights from https://github.com/Tencent/MedicalNet
#   Step 2: python 01_prepare_dataset.py --config config.yaml
#   Step 3: python train.py --config config.yaml

# =============================================================================
# DATA PATHS - Edit these for your setup
# =============================================================================
data:
  # Input data (skull-stripped MRI scans from ADNI_skull)
  dxsum_csv: "/Volumes/KINGSTON/dxsum.csv"
  skull_dir: "/Volumes/KINGSTON/ADNI-skull"  # Skull-stripped, registered MRI scans

  # Output paths (relative to this experiment folder)
  splits_dir: "data/splits"          # Where to save train/val/test CSVs
  checkpoints_dir: "data/checkpoints" # Where to save model checkpoints
  logs_dir: "data/logs"               # TensorBoard logs
  results_dir: "data/results"         # Evaluation results

  # Automatically generated paths (don't edit)
  train_csv: "data/splits/train.csv"
  val_csv: "data/splits/val.csv"
  test_csv: "data/splits/test.csv"

# =============================================================================
# DATASET PREPARATION (Step 1)
# =============================================================================
dataset_preparation:
  train_ratio: 0.8                   # 80% training
  val_ratio: 0.1                     # 10% validation
  test_ratio: 0.1                    # 10% test
  random_seed: 42

# =============================================================================
# MODEL ARCHITECTURE - MedicalNet 3D ResNet
# =============================================================================
model:
  name: "ResNet3D"
  architecture: "resnet18"           # Options: resnet10, resnet18, resnet34, resnet50

  # Image/volume configuration
  image_size: 192              # Input volume size (192x192x192)
  num_channels: 1              # Number of input channels (grayscale MRI)
  num_classes: 3               # 3-class classification (CN vs MCI vs AD)

  # Transfer learning
  use_pretrained: true         # Use MedicalNet pretrained weights
  pretrained_path: "pretrained/resnet_18.pth"  # Path to pretrained weights
  freeze_backbone: false       # Set to true to freeze all layers except FC

# =============================================================================
# TRAINING HYPERPARAMETERS
# =============================================================================
training:
  batch_size: 4                # Batch size (increased from 2 since ResNet-18 is lighter)
  epochs: 100                  # Maximum number of epochs
  learning_rate: 0.0001        # Initial learning rate (1e-4)
  weight_decay: 0.0001         # Weight decay for AdamW
  optimizer: "AdamW"           # Optimizer

  # Learning rate scheduler
  scheduler: "CosineAnnealing"  # Cosine annealing LR scheduler
  lr_min: 0.00001              # Minimum learning rate (1e-5)

  # Class balancing
  use_weighted_loss: true      # Use weighted cross-entropy for class imbalance
  use_weighted_sampling: false # Use weighted random sampler

  # Reproducibility
  seed: 42                     # Random seed

# =============================================================================
# DATA AUGMENTATION
# =============================================================================
augmentation:
  enabled: true                # Enable data augmentation
  random_flip_prob: 0.5        # Probability of random flip
  random_rotation_degrees: 10  # Max rotation degrees
  random_affine: false         # Apply random affine transforms
  intensity_shift: true        # Random intensity shifts
  intensity_scale: true        # Random intensity scaling

# =============================================================================
# HARDWARE & PERFORMANCE
# =============================================================================
hardware:
  device: "cuda"               # cuda or cpu
  num_workers: 4               # Number of dataloader workers
  pin_memory: true             # Pin memory for faster GPU transfer
  mixed_precision: true        # Use automatic mixed precision (FP16) for speed

# =============================================================================
# CALLBACKS & MONITORING
# =============================================================================
callbacks:
  early_stopping:
    enabled: true
    patience: 15               # Stop if no improvement after 15 epochs
    monitor: "val_accuracy"    # Metric to monitor
    mode: "max"                # Maximize accuracy

  checkpoint:
    save_top_k: 3              # Save top 3 checkpoints
    monitor: "val_accuracy"    # Metric to monitor for best checkpoint
    mode: "max"                # Maximize
    save_last: true            # Always save last checkpoint

  logging:
    log_every_n_steps: 10      # Log metrics every N steps
    save_training_plot: true   # Save training curves

# =============================================================================
# WEIGHTS & BIASES (WANDB) LOGGING
# =============================================================================
wandb:
  enabled: true                # Enable/disable wandb logging
  project: "alzheimer-research"
  entity: null                 # Wandb entity/team name (null = use default)
  run_name: "cn-mci-ad-medicalnet-resnet18"  # Custom run name
  log_model: false             # Upload model checkpoints to wandb
  tags:
    - medicalnet
    - transfer-learning
    - resnet18
    - 3-class-classification
    - cn-mci-ad
    - patient-level-split
  notes: "MedicalNet ResNet-18 transfer learning for CN/MCI/AD classification (patient-level split)"

# =============================================================================
# EVALUATION
# =============================================================================
evaluation:
  metrics:
    - accuracy
    - balanced_accuracy
    - precision
    - recall
    - f1
    - auc
    - confusion_matrix

  save_predictions: true       # Save predictions on test set
  save_attention_maps: false   # Save attention visualizations
